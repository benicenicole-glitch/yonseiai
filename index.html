<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ezlive - P2P í™”ìƒ ê°•ì˜/ì±„íŒ…</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .ez-button { transition: all 0.2s; }
        .ez-button:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        
        /* ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ: 1:1 ë¹„ìœ¨ì„ ìœ ì§€í•˜ê³  ë°”ë‘‘íŒì‹ ë ˆì´ì•„ì›ƒì„ ìœ„í•œ ê¸°ë³¸ ì„¤ì • */
        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* ëª¨ë°”ì¼ ì¹œí™”ì ì¸ ê·¸ë¦¬ë“œ */
            gap: 16px;
            padding: 16px;
            align-items: center;
            justify-items: center;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 ë¹„ìœ¨ì„ ìœ„í•œ íŠ¸ë¦­ */
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background-color: #1f2937;
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* ë¹„ë””ì˜¤ ë¹„ìœ¨ ìœ ì§€ */
            border-radius: 12px;
        }

        .video-label {
            position: absolute;
            bottom: 0;
            left: 0;
            padding: 4px 8px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 0.75rem;
            border-top-right-radius: 8px;
        }

        /* ì „ì²´í™”ë©´ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .fullscreen-layout #video-grid {
            display: flex;
            flex-direction: column;
            gap: 0; /* ì‘ì€ ì¸ë„¤ì¼ ê°„ê²© ì œê±° */
            padding: 0;
            width: 100px; /* ì¸ë„¤ì¼ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ */
            height: 100vh;
            overflow-y: auto;
            position: absolute;
            left: 0;
            top: 0;
            background-color: #2c3e50;
        }

        .fullscreen-layout .video-container {
            width: 100%;
            padding-top: 56.25%; /* 16:9 ì¸ë„¤ì¼ ë¹„ìœ¨ (ì¼ë°˜ì ì¸ ì›¹ìº /í™”ë©´ ë¹„ìœ¨) */
            height: auto;
            margin-bottom: 8px;
            box-shadow: none;
            border-radius: 0;
        }

        .fullscreen-layout .video-container.main-video {
            position: absolute;
            left: 100px; /* ì¸ë„¤ì¼ íŒ¨ë„ ë„ˆë¹„ë§Œí¼ ì´ë™ */
            top: 0;
            width: calc(100% - 100px);
            height: 100vh;
            padding-top: 0;
            border-radius: 0;
            box-shadow: none;
        }

        .fullscreen-layout .video-container.main-video video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ì „ì²´ í™”ë©´ì— ë§ì¶”ë˜ ë¹„ìœ¨ ìœ ì§€ */
            border-radius: 0;
        }
        
        /* PiP ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .pip-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            line-height: 1;
        }

        /* íŒì„œ ë„êµ¬ ìŠ¤íƒ€ì¼ (ìƒˆ ì°½ ëª¨ë‹¬ ì‹œë®¬ë ˆì´ì…˜) */
        #whiteboard-modal {
            max-width: 90vw;
            width: 800px;
            max-height: 90vh;
            height: 600px;
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            padding: 0;
            overflow: hidden;
        }

        #whiteboard-modal::backdrop {
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
    <!-- PeerJS CDN ë¡œë“œ -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Firebase SDK (í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©ì„ ìœ„í•¨) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        window.isFirebaseReady = false;

        setLogLevel('debug'); // Firestore ë¡œê·¸ ë ˆë²¨ ì„¤ì •

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize.");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db;
                window.auth = auth;
                window.appId = appId;
                
                // ì¸ì¦ ì²˜ë¦¬
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        window.userId = userId;
                        window.isFirebaseReady = true;
                        document.dispatchEvent(new CustomEvent('firebaseReady'));
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        console.log("User signed out or failed to sign in.");
                        // ë¹„ì¸ì¦ ì‚¬ìš©ì ì²˜ë¦¬ (P2P ì•±ì´ë¼ ì¤‘ìš”ë„ê°€ ë‚®ì§€ë§Œ, DB ì‚¬ìš©ì„ ìœ„í•´ í•„ìš”)
                        userId = crypto.randomUUID();
                        window.userId = userId;
                        window.isFirebaseReady = true;
                        document.dispatchEvent(new CustomEvent('firebaseReady'));
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or auth failed:", error);
            }
        }
        initFirebase();
    </script>
</head>
<body class="min-h-screen flex flex-col">
    <div id="app" class="flex-grow flex flex-col">

        <!-- ì´ˆê¸° ì§„ì… í™”ë©´ (í™ˆ) -->
        <div id="home-view" class="flex-grow flex items-center justify-center bg-gray-100 p-4">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">ezlive</h1>
                <p class="text-gray-600 mb-8">P2P í™”ìƒê°•ì˜/ì±„íŒ… ì†”ë£¨ì…˜</p>
                
                <button onclick="changeView('teacher_setup')"
                        class="ez-button w-full py-3 mb-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 shadow-md">
                    êµì‚¬ìš© í™”ìƒê°•ì˜ ìƒì„±
                </button>
                
                <button onclick="changeView('student_join')"
                        class="ez-button w-full py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 shadow-md">
                    í•™ìƒìš© ê°•ì˜ì°¸ì—¬
                </button>
            </div>
        </div>

        <!-- êµì‚¬ìš© ì„¤ì • í™”ë©´ -->
        <div id="teacher-setup-view" class="hidden flex-grow flex items-center justify-center bg-gray-100 p-4">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">êµì‚¬ìš© í™”ìƒê°•ì˜ ìƒì„±</h2>
                
                <input id="teacher-room-id" type="text" placeholder="ë°© ì´ë¦„ (Host ID)"
                       class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                
                <input id="teacher-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (a123456!)"
                       class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" value="a123456!" required>
                       
                <div class="mb-6">
                    <p class="text-sm font-semibold mb-2 text-gray-700">í•™ìƒ ì •ë³´ ì„¤ì • (ì„ íƒ ì‚¬í•­)</p>
                    <p class="text-xs text-red-500 mb-2">ë‹¨ì¼ íŒŒì¼ í™˜ê²½ì˜ í•œê³„ë¡œ ì¸í•´, í˜„ì¬ëŠ” Host IDì™€ ë¹„ë°€ë²ˆí˜¸ë§Œìœ¼ë¡œ ì…ì¥í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
                    <!-- ì´ ë¶€ë¶„ì€ UIë§Œ ì œê³µí•˜ê³  ì‹¤ì œ ë³µì¡í•œ DB ì¸ì¦ì€ ìŠ¤í‚µí•©ë‹ˆë‹¤. -->
                    <input id="student-name-config" type="text" placeholder="í•™ìƒ ì´ë¦„ (e.g., Jane)"
                           class="w-full p-2 mb-2 border border-gray-200 rounded-md">
                    <input id="student-password-config" type="password" placeholder="í•™ìƒ ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ)"
                           class="w-full p-2 border border-gray-200 rounded-md">
                </div>

                <button onclick="startTeacherSession()"
                        class="ez-button w-full py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 shadow-md">
                    ê°•ì˜ ì‹œì‘
                </button>
                
                <button onclick="changeView('home')"
                        class="ez-button w-full py-3 mt-4 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 shadow-md">
                    ë’¤ë¡œê°€ê¸°
                </button>
                <p id="teacher-error" class="text-red-500 text-center mt-3 hidden">ì˜¤ë¥˜ ë©”ì‹œì§€</p>
            </div>
        </div>

        <!-- í•™ìƒìš© ì°¸ê°€ í™”ë©´ -->
        <div id="student-join-view" class="hidden flex-grow flex items-center justify-center bg-gray-100 p-4">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">í•™ìƒìš© ê°•ì˜ì°¸ì—¬</h2>
                
                <input id="student-room-id" type="text" placeholder="Host ID (êµì‚¬ê°€ ê³µìœ í•œ ì£¼ì†Œ)"
                       class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                
                <input id="student-display-name" type="text" placeholder="ì‚¬ìš©ì ì´ë¦„"
                       class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                       
                <input id="student-password-enter" type="password" placeholder="ì…ì¥ ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ ì‚¬í•­)"
                       class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                
                <button onclick="joinStudentSession()"
                        class="ez-button w-full py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 shadow-md">
                    ì°¸ì—¬í•˜ê¸°
                </button>
                
                <button onclick="changeView('home')"
                        class="ez-button w-full py-3 mt-4 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 shadow-md">
                    ë’¤ë¡œê°€ê¸°
                </button>
                <p id="student-error" class="text-red-500 text-center mt-3 hidden">ì˜¤ë¥˜ ë©”ì‹œì§€</p>
            </div>
        </div>

        <!-- ë©”ì¸ ê°•ì˜ì‹¤ í™”ë©´ -->
        <div id="room-view" class="hidden flex-grow flex-col h-full overflow-hidden">
            <div id="room-content" class="flex flex-col md:flex-row flex-grow h-full overflow-hidden">
                
                <!-- 1. ë¹„ë””ì˜¤/í™”ë©´ ê³µìœ  ì˜ì—­ (ì „ì²´ ë„ˆë¹„, ìœ ë™ ë†’ì´) -->
                <div id="video-panel" class="md:flex-grow h-3/5 md:h-full bg-gray-800 relative transition-all duration-300">
                    
                    <!-- ì œì–´ ë²„íŠ¼ (ì™¼ìª½ ìƒë‹¨) -->
                    <div id="control-buttons" class="absolute top-2 left-2 flex flex-col space-y-2 z-20">
                        <button onclick="toggleMedia('video')" class="ez-button p-2 bg-red-500 text-white rounded-lg shadow-lg hover:bg-red-600 text-xs md:text-sm" title="ë¹„ë””ì˜¤ ì¼œê¸°/ë„ê¸°">
                            <span id="video-icon">ğŸ“¹</span>
                        </button>
                        <button onclick="toggleMedia('audio')" class="ez-button p-2 bg-red-500 text-white rounded-lg shadow-lg hover:bg-red-600 text-xs md:text-sm" title="ì˜¤ë””ì˜¤ ì¼œê¸°/ë„ê¸°">
                            <span id="audio-icon">ğŸ¤</span>
                        </button>
                        <button onclick="startScreenShare()" class="ez-button p-2 bg-red-500 text-white rounded-lg shadow-lg hover:bg-red-600 text-xs md:text-sm" title="í™”ë©´ ê³µìœ  ì‹œì‘/ì¢…ë£Œ">
                            <span id="screen-share-icon">ğŸ–¥ï¸</span>
                        </button>
                        <button onclick="toggleWhiteboard()" class="ez-button p-2 bg-purple-500 text-white rounded-lg shadow-lg hover:bg-purple-600 text-xs md:text-sm" title="íŒì„œ ë„êµ¬">
                            <span id="board-icon">ğŸ–Œï¸</span>
                        </button>
                        <button onclick="saveChatToCSV()" class="ez-button p-2 bg-indigo-500 text-white rounded-lg shadow-lg hover:bg-indigo-600 text-xs md:text-sm" title="ì±„íŒ… ê¸°ë¡ ì €ì¥ (CSV)">
                            <span id="save-chat-icon">ğŸ’¾</span>
                        </button>
                        <button onclick="toggleVideoFullscreen()" class="ez-button p-2 bg-yellow-500 text-white rounded-lg shadow-lg hover:bg-yellow-600 text-xs md:text-sm" title="ì „ì²´í™”ë©´ ì „í™˜">
                            <span id="fullscreen-icon">ğŸ“º</span>
                        </button>
                        <button onclick="endSession()" class="ez-button p-2 bg-gray-500 text-white rounded-lg shadow-lg hover:bg-gray-600 text-xs md:text-sm" title="ê°•ì˜ ì¢…ë£Œ">
                            <span id="end-icon">ğŸšª</span>
                        </button>
                    </div>

                    <!-- ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ -->
                    <div id="video-grid" class="w-full h-full">
                        <!-- ë¹„ë””ì˜¤ ìš”ì†Œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>

                    <!-- ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œë§Œ ë³´ì´ëŠ” ì±„íŒ… ë²„íŠ¼ -->
                    <button id="fullscreen-chat-btn" onclick="toggleChatDisplay(true)"
                            class="absolute top-2 right-2 p-2 bg-gray-700 text-white rounded-lg shadow-lg z-30 hidden ez-button">
                        ì±„íŒ… ë³´ê¸°
                    </button>
                </div>

                <!-- 2. ì±„íŒ… ì˜ì—­ (ëª¨ë°”ì¼: ì•„ë˜, ë°ìŠ¤í¬í†±: ì˜¤ë¥¸ìª½) -->
                <div id="chat-panel" class="md:w-96 w-full h-2/5 md:h-full flex flex-col bg-white border-l border-gray-200 transition-all duration-300">
                    <!-- ì±„íŒ… ì°½ í† ê¸€ ë²„íŠ¼ (ì „ì²´í™”ë©´ì—ì„œ ëŒì•„ê°€ê¸°) -->
                    <div id="chat-toggle-header" class="flex justify-between items-center p-3 bg-gray-50 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">ezlive ì±„íŒ…</h3>
                        <button id="chat-close-btn" onclick="toggleChatDisplay(false)" class="text-gray-500 hover:text-gray-700 hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
                    <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-3 bg-gray-50">
                        <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>

                    <!-- ì±„íŒ… ì…ë ¥ ë° íŒŒì¼ ì „ì†¡ -->
                    <div class="p-3 border-t border-gray-200 bg-white">
                        <div class="flex items-center space-x-2">
                            <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                   class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            
                            <label for="file-input" class="ez-button p-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 cursor-pointer" title="íŒŒì¼ ì „ì†¡">
                                ğŸ“
                            </label>
                            <input type="file" id="file-input" class="hidden" onchange="sendFile()">

                            <button onclick="sendMessage()"
                                    class="ez-button p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                ì „ì†¡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- íŒì„œ ë„êµ¬ ëª¨ë‹¬ (ìƒˆ ì°½ ì‹œë®¬ë ˆì´ì…˜) -->
        <dialog id="whiteboard-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50">
            <div class="flex flex-col h-full">
                <div class="p-3 bg-gray-700 text-white flex items-center justify-between rounded-t-xl">
                    <h3 class="text-xl font-bold">íŒì„œ ë„êµ¬ (í˜ì´ì§€: <span id="current-page-display">1</span>)</h3>
                    <div id="whiteboard-page-controls" class="flex space-x-2 items-center">
                        <button onclick="whiteboardPageChange(-1)" class="ez-button p-1 bg-gray-600 rounded-md hover:bg-gray-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <span class="text-sm">Page <span id="current-page-num">1</span> / <span id="total-pages-num">1</span></span>
                        <button onclick="whiteboardPageChange(1)" class="ez-button p-1 bg-gray-600 rounded-md hover:bg-gray-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- ë„êµ¬ íŒ¨ë„ -->
                <div class="p-3 bg-gray-100 flex flex-wrap gap-2 items-center border-b">
                    <button onclick="setTool('pen')" class="ez-button p-2 rounded-lg bg-blue-500 text-white" id="tool-pen">íœ</button>
                    <button onclick="setTool('eraser')" class="ez-button p-2 rounded-lg bg-gray-300 text-gray-800" id="tool-eraser">ì§€ìš°ê°œ</button>
                    <button onclick="setTool('pointer')" class="ez-button p-2 rounded-lg bg-gray-300 text-gray-800" id="tool-pointer">í¬ì¸íŠ¸</button>
                    <input type="color" id="whiteboard-color" value="#000000" class="w-10 h-10 rounded-lg">
                    <input type="range" min="1" max="50" value="5" id="whiteboard-size" onchange="document.getElementById('size-display').textContent=this.value" class="w-20">
                    <span id="size-display" class="text-sm">5</span>
                    <button onclick="clearWhiteboardPage()" class="ez-button p-2 rounded-lg bg-red-500 text-white">ì „ì²´ ì§€ìš°ê¸°</button>
                    <button onclick="newWhiteboardPage()" class="ez-button p-2 rounded-lg bg-green-500 text-white">ìƒˆ í˜ì´ì§€ ë§Œë“¤ê¸°</button>
                    <button onclick="saveCurrentPageAsPNG()" class="ez-button p-2 rounded-lg bg-indigo-500 text-white">í˜„ì¬ í˜ì´ì§€ ì €ì¥ (PNG)</button>
                    <button onclick="saveAllPagesAsPDF()" class="ez-button p-2 rounded-lg bg-indigo-500 text-white">ëª¨ë‘ ì €ì¥ (PDF)</button>
                    <button onclick="closeWhiteboard()" class="ez-button p-2 rounded-lg bg-gray-500 text-white">ì¢…ë£Œ</button>
                </div>
                
                <!-- ìº”ë²„ìŠ¤ ì˜ì—­ -->
                <div class="flex-grow bg-white relative">
                    <canvas id="whiteboard-canvas" class="w-full h-full"></canvas>
                </div>
            </div>
        </dialog>
    </div>

    <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ (PDF ì €ì¥ì„ ìœ„í•´) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // =================================================================
        // Global Variables and State Management
        // =================================================================
        const views = ['home-view', 'teacher-setup-view', 'student-join-view', 'room-view'];
        let currentView = 'home';

        // P2P State
        let peer = null;
        let myStream = null;
        let screenStream = null;
        let myPeerId = null;
        let connections = {}; // Stores all active connections: {peerId: {call, dataConnection, displayName, stream}}
        
        // Media State
        let isVideoOn = true;
        let isAudioOn = true;
        let isScreenSharing = false;
        let isVideoFullscreen = false;

        // Whiteboard State
        let whiteboardModal = document.getElementById('whiteboard-modal');
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let currentSize = 5;
        let whiteboardPages = []; // Stores canvas Data URLs
        let currentPage = 0;

        // Constants
        const TEACHER_PASSWORD = 'a123456!';
        const PEERJS_HOST = '0.peerjs.com'; // Public PeerJS Server
        const PEERJS_PORT = 443;
        const PEERJS_PATH = '/';
        const PEERJS_SECURE = true;

        // =================================================================
        // Utility Functions (View, UI, Data)
        // =================================================================

        /**
         * ë·° ì „í™˜ í•¨ìˆ˜
         * @param {string} viewId - ì „í™˜í•  ë·° ID (home, teacher_setup, student_join, room)
         */
        function changeView(viewId) {
            currentView = viewId;
            views.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                    if (id.startsWith(viewId)) {
                        element.classList.remove('hidden');
                    }
                }
            });
        }

        /**
         * P2P ì—°ê²° ì¢…ë£Œ ë° ìƒíƒœ ì´ˆê¸°í™”
         */
        function endSession() {
            Object.values(connections).forEach(conn => {
                if (conn.call) conn.call.close();
                if (conn.dataConnection) conn.dataConnection.close();
            });
            connections = {};
            
            if (myStream) {
                myStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            if (peer) {
                peer.destroy();
                peer = null;
            }

            // ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
            const grid = document.getElementById('video-grid');
            grid.innerHTML = '';
            
            // ì±„íŒ… ë° UI ì´ˆê¸°í™”
            document.getElementById('chat-messages').innerHTML = '';
            isScreenSharing = false;
            isVideoFullscreen = false;
            document.getElementById('room-view').classList.remove('fullscreen-layout');
            document.getElementById('fullscreen-chat-btn').classList.add('hidden');

            console.log("ì„¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            changeView('home');
        }

        /**
         * ë¹„ë””ì˜¤ ìš”ì†Œë¥¼ ìƒì„±í•˜ê³  ê·¸ë¦¬ë“œì— ì¶”ê°€
         * @param {MediaStream} stream - ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼
         * @param {string} id - Peer ID ë˜ëŠ” 'my-video'
         * @param {string} displayName - í‘œì‹œ ì´ë¦„
         * @returns {HTMLVideoElement} - ìƒì„±ëœ ë¹„ë””ì˜¤ ìš”ì†Œ
         */
        function addVideoStream(stream, id, displayName) {
            let videoContainer = document.getElementById(`container-${id}`);
            let video = document.getElementById(`video-${id}`);
            const videoGrid = document.getElementById('video-grid');

            if (!videoContainer) {
                videoContainer = document.createElement('div');
                videoContainer.id = `container-${id}`;
                videoContainer.classList.add('video-container');

                video = document.createElement('video');
                video.id = `video-${id}`;
                video.autoplay = true;
                video.playsInline = true; // ëª¨ë°”ì¼ ì¬ìƒì„ ìœ„í•´ í•„ìˆ˜

                if (id === 'my-video') {
                    video.muted = true; // ìì‹ ì˜ ë¹„ë””ì˜¤ëŠ” ìŒì†Œê±°
                }

                const label = document.createElement('span');
                label.classList.add('video-label');
                label.textContent = displayName || id;

                // PiP ë²„íŠ¼ ì¶”ê°€ (ìƒëŒ€ë°© ë¹„ë””ì˜¤ì—ë§Œ ì¶”ê°€, ë‚´ ë¹„ë””ì˜¤ëŠ” UIì—ì„œ ë³„ë„ ì²˜ë¦¬)
                if (id !== 'my-video') {
                    const pipBtn = document.createElement('button');
                    pipBtn.classList.add('pip-btn');
                    pipBtn.textContent = 'PiP';
                    pipBtn.onclick = () => video.requestPictureInPicture().catch(e => console.error("PiP ì‹¤íŒ¨:", e));
                    videoContainer.appendChild(pipBtn);
                }
                
                // ë‚´ ë¹„ë””ì˜¤ì— ì „ì²´í™”ë©´ ë²„íŠ¼ ì¶”ê°€
                if (id === 'my-video') {
                    const pipBtn = document.createElement('button');
                    pipBtn.classList.add('pip-btn', 'left-4', 'right-auto');
                    pipBtn.textContent = 'PIP';
                    pipBtn.onclick = () => video.requestPictureInPicture().catch(e => console.error("PiP ì‹¤íŒ¨:", e));
                    videoContainer.appendChild(pipBtn);
                }


                videoContainer.appendChild(video);
                videoContainer.appendChild(label);
                videoGrid.appendChild(videoContainer);

                video.srcObject = stream;
            } else {
                 // ìŠ¤íŠ¸ë¦¼ë§Œ ì—…ë°ì´íŠ¸ (ì˜ˆ: í™”ë©´ ê³µìœ ë¡œ ì „í™˜ ì‹œ)
                video.srcObject = stream;
            }

            // ì „ì²´ í™”ë©´ ëª¨ë“œì¼ ë•Œ ë ˆì´ì•„ì›ƒ ì—…ë°ì´íŠ¸
            updateVideoLayout();

            return video;
        }

        /**
         * ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œì—ì„œ íŠ¹ì • ë¹„ë””ì˜¤ ì œê±°
         * @param {string} id - ì œê±°í•  Peer ID ë˜ëŠ” 'my-video'
         */
        function removeVideoStream(id) {
            const videoContainer = document.getElementById(`container-${id}`);
            if (videoContainer) {
                videoContainer.remove();
                console.log(`ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ${id} ì œê±°ë¨`);
            }
            updateVideoLayout();
        }

        /**
         * PiP ê¸°ëŠ¥ì„ ìœ„í•œ ë¹„ë””ì˜¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
         */
        function getMyVideoElement() {
            return document.getElementById('video-my-video');
        }

        /**
         * ì±„íŒ… ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
         * @param {string} sender - ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„
         * @param {string} message - ë©”ì‹œì§€ ë‚´ìš©
         * @param {string} type - 'system', 'local', 'remote', 'file'
         */
        function displayMessage(sender, message, type = 'remote') {
            const chatMessages = document.getElementById('chat-messages');
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            const isLocal = type === 'local';
            const isSystem = type === 'system';

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'space-x-3', 'max-w-xs', 'md:max-w-md', 'break-words');
            
            if (isLocal) {
                messageDiv.classList.add('justify-end', 'ml-auto');
            } else if (isSystem) {
                messageDiv.classList.add('justify-center', 'text-center', 'w-full');
            }

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('rounded-xl', 'p-3', 'shadow-md', 'text-sm');

            if (isLocal) {
                contentDiv.classList.add('bg-blue-500', 'text-white');
            } else if (isSystem) {
                contentDiv.classList.add('bg-yellow-100', 'text-gray-700', 'text-xs', 'italic');
            } else { // remote or file
                contentDiv.classList.add('bg-gray-200', 'text-gray-800');
            }
            
            if (!isSystem) {
                contentDiv.innerHTML = `<p class="font-semibold ${isLocal ? 'text-white' : 'text-gray-600'} text-xs mb-1">${sender} <span class="font-normal opacity-70 ml-2">${time}</span></p>
                                        <p class="${type === 'file' ? 'text-blue-700 font-bold' : ''}">${message}</p>`;
            } else {
                 contentDiv.innerHTML = `<p>${message}</p>`;
            }


            if (isLocal) {
                messageDiv.appendChild(contentDiv);
            } else {
                messageDiv.appendChild(contentDiv);
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ

            // ì±„íŒ… ê¸°ë¡ ì €ì¥
            chatHistory.push({ time, sender, message, type });
        }
        
        // =================================================================
        // PeerJS and RTC Logic
        // =================================================================
        
        /**
         * PeerJS ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
         * @param {string} id - Host ID (êµì‚¬) ë˜ëŠ” undefined (í•™ìƒ)
         */
        function initPeer(id) {
            return new Promise((resolve, reject) => {
                const peerOptions = {
                    host: PEERJS_HOST,
                    port: PEERJS_PORT,
                    path: PEERJS_PATH,
                    secure: PEERJS_SECURE
                };
                
                peer = new Peer(id, peerOptions);

                peer.on('open', (id) => {
                    myPeerId = id;
                    console.log('Peer ID:', id);
                    displayMessage('System', `ë‚˜ì˜ IDê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${id}`, 'system');
                    resolve(id);
                });

                peer.on('error', (err) => {
                    console.error("PeerJS Error:", err);
                    alert(`PeerJS ì˜¤ë¥˜ ë°œìƒ: ${err.type}. ì„œë²„ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.`);
                    reject(err);
                });

                // Host (êµì‚¬)ì˜ ê²½ìš°: ë“¤ì–´ì˜¤ëŠ” ì—°ê²° ìˆ˜ë½
                peer.on('call', handleIncomingCall);
                peer.on('connection', handleIncomingDataConnection);

                peer.on('disconnected', () => {
                    console.warn("PeerJS Disconnected. Attempting to reconnect...");
                    peer.reconnect();
                });
            });
        }
        
        /**
         * ë¹„ë””ì˜¤ ë° ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸°
         * @returns {Promise<MediaStream>} - ë¡œì»¬ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼
         */
        async function getLocalStream() {
            try {
                // ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©ìì—ê²Œ ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤.
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                myStream = stream;
                // ì´ˆê¸° ë¹„ë””ì˜¤ ìƒíƒœ ì„¤ì •
                myStream.getVideoTracks()[0].enabled = isVideoOn;
                myStream.getAudioTracks()[0].enabled = isAudioOn;
                
                addVideoStream(myStream, 'my-video', document.getElementById('student-display-name').value || 'ë‚˜');
                return stream;
            } catch (err) {
                console.error("ë¡œì»¬ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œ í•„ìš”)", err);
                displayMessage('System', 'ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.', 'system');
                throw err;
            }
        }

        /**
         * ë“¤ì–´ì˜¤ëŠ” í™”ìƒ í†µí™” ì²˜ë¦¬ (Host/Client ê³µí†µ)
         * @param {Peer.Call} call - PeerJS Call ê°ì²´
         */
        function handleIncomingCall(call) {
            console.log('Incoming call from:', call.peer);
            
            // ì‘ë‹µ
            call.answer(myStream);

            const connData = connections[call.peer] || { displayName: call.peer };
            connData.call = call;
            connections[call.peer] = connData;

            call.on('stream', (remoteStream) => {
                console.log('Remote stream received from:', call.peer);
                // ëª¨ë“  ì—°ê²°ì— displayNameì„ ì„¤ì •í–ˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
                const displayName = connections[call.peer].displayName || call.peer;
                addVideoStream(remoteStream, call.peer, displayName);
                connData.stream = remoteStream;
            });

            call.on('close', () => {
                console.log('Call closed with:', call.peer);
                removeVideoStream(call.peer);
                delete connections[call.peer].call;
            });
            
            call.on('error', (err) => {
                console.error('Call error with:', call.peer, err);
            });
        }
        
        /**
         * ë“¤ì–´ì˜¤ëŠ” ë°ì´í„° ì—°ê²° ì²˜ë¦¬ (Host/Client ê³µí†µ)
         * @param {Peer.DataConnection} conn - PeerJS DataConnection ê°ì²´
         */
        function handleIncomingDataConnection(conn) {
            console.log('Incoming data connection from:', conn.peer);
            
            const connData = connections[conn.peer] || { displayName: conn.peer };
            connData.dataConnection = conn;
            connections[conn.peer] = connData;

            conn.on('open', () => {
                console.log('Data connection established with:', conn.peer);
                displayMessage('System', `${conn.peer}ë‹˜ì´ ê°•ì˜ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.`, 'system');
                // ì—°ê²°ì´ ì—´ë¦¬ë©´ ë©”íƒ€ë°ì´í„°(ì´ë¦„) ì „ì†¡
                conn.send({ type: 'metadata', name: document.getElementById('student-display-name').value || myPeerId });
            });

            conn.on('data', (data) => {
                handlePeerData(conn.peer, data);
            });

            conn.on('close', () => {
                console.log('Data connection closed with:', conn.peer);
                displayMessage('System', `${conn.peer}ë‹˜ì´ ê°•ì˜ë¥¼ ë‚˜ê°”ìŠµë‹ˆë‹¤.`, 'system');
                delete connections[conn.peer];
                removeVideoStream(conn.peer);
            });

             conn.on('error', (err) => {
                console.error('Data connection error with:', conn.peer, err);
            });
        }

        /**
         * íŠ¹ì • í”¼ì–´ì— ë°ì´í„° ì—°ê²° ì‹œë„
         * @param {string} peerId - ì—°ê²°í•  Peer ID
         */
        function connectToPeer(peerId) {
            // 1. Data Connection ì‹œë„
            const conn = peer.connect(peerId);
            handleIncomingDataConnection(conn); // DataChannel ì´ë²¤íŠ¸ ë“±ë¡
            
            // 2. Media Call ì‹œë„ (ìŠ¤íŠ¸ë¦¼ êµí™˜)
            const call = peer.call(peerId, myStream);
            handleIncomingCall(call); // Call ì´ë²¤íŠ¸ ë“±ë¡

            // ë°ì´í„°ì™€ ì½œ ê°ì²´ë¥¼ connectionsì— ì €ì¥
            connections[peerId] = { 
                ...connections[peerId], 
                call: call, 
                dataConnection: conn, 
                displayName: document.getElementById('student-display-name').value || myPeerId
            };
        }

        /**
         * PeerJS DataChannelì„ í†µí•´ ìˆ˜ì‹ ëœ ë°ì´í„° ì²˜ë¦¬
         * @param {string} senderId - ë³´ë‚¸ ì‚¬ëŒ Peer ID
         * @param {object} data - ìˆ˜ì‹ ëœ JSON ë°ì´í„°
         */
        function handlePeerData(senderId, data) {
            const displayName = connections[senderId]?.displayName || senderId;

            switch (data.type) {
                case 'metadata':
                    // ì´ë¦„ ì—…ë°ì´íŠ¸
                    connections[senderId].displayName = data.name;
                    // ë¹„ë””ì˜¤ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
                    const label = document.querySelector(`#container-${senderId} .video-label`);
                    if (label) label.textContent = data.name;

                    displayMessage('System', `${senderId}ë‹˜ì˜ ì´ë¦„ì´ ${data.name}ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
                    break;
                case 'chat':
                    displayMessage(displayName, data.message, 'remote');
                    break;
                case 'file':
                    // íŒŒì¼ ìˆ˜ì‹  ì²˜ë¦¬
                    handleFileReceive(displayName, data);
                    break;
                case 'drawing':
                    // íŒì„œ ëª…ë ¹ ì²˜ë¦¬
                    executeDrawingCommand(data);
                    break;
                case 'stream_change':
                    // ìŠ¤íŠ¸ë¦¼ êµì²´ (í™”ë©´ ê³µìœ  ì‹œì‘/ì¢…ë£Œ ë“±)
                    // ì´ ìš”ì²­ì„ ë³´ë‚¸ í”¼ì–´ì— ëŒ€í•´ ìŠ¤íŠ¸ë¦¼ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•˜ì§€ë§Œ, PeerJSëŠ” Call.replaceTrack()ì„ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤.
                    // ê°„ë‹¨íˆ ê¸°ì¡´ Callì„ ë‹«ê³  ë‹¤ì‹œ ê±°ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤ (replaceTrackì´ ë” íš¨ìœ¨ì ì„).
                    // í˜„ì¬ëŠ” í™”ë©´ ê³µìœ  ì‹œ ìƒˆ Callì„ ê±¸ê³  ê¸°ì¡´ Callì„ ë‹«ë„ë¡ êµ¬í˜„í•  ì˜ˆì •ì´ë¯€ë¡œ, ìˆ˜ì‹  ì¸¡ì€ ê¸°ì¡´ call.on('stream')ì„ ë”°ë¦…ë‹ˆë‹¤.
                    displayMessage('System', `${displayName}ë‹˜ì´ ${data.status}ì„(ë¥¼) ì‹œì‘í–ˆìŠµë‹ˆë‹¤.`, 'system');
                    break;
                default:
                    console.log('Unknown data type received:', data);
            }
        }
        
        // =================================================================
        // Session Initialization
        // =================================================================

        /**
         * êµì‚¬ ì„¸ì…˜ ì‹œì‘ (Host)
         */
        async function startTeacherSession() {
            const roomId = document.getElementById('teacher-room-id').value.trim();
            const password = document.getElementById('teacher-password').value;
            const errorElement = document.getElementById('teacher-error');
            const displayName = 'êµì‚¬ (Host)';
            document.getElementById('student-display-name').value = displayName; // ì´ë¦„ ì„¤ì •

            if (!roomId) {
                errorElement.textContent = 'ë°© ì´ë¦„(Host ID)ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.';
                errorElement.classList.remove('hidden');
                return;
            }
            if (password !== TEACHER_PASSWORD) {
                errorElement.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errorElement.classList.remove('hidden');
                return;
            }
            errorElement.classList.add('hidden');

            try {
                // 1. ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° (ì¹´ë©”ë¼/ë§ˆì´í¬)
                await getLocalStream();
                
                // 2. PeerJS ì´ˆê¸°í™” (Host ID ì‚¬ìš©)
                await initPeer(roomId);
                
                // 3. UI ì „í™˜
                changeView('room');
                displayMessage('System', `ê°•ì˜ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ID: ${roomId}`, 'system');

                // 4. Host ID ê³µìœ  ì•ˆë‚´ (í´ë¦½ë³´ë“œ ë³µì‚¬)
                const shareUrl = `${window.location.href.split('?')[0]}?room=${roomId}&name=${encodeURIComponent(displayName)}`;
                await copyToClipboard(`ê°•ì˜ ID: ${roomId}\nì°¸ì—¬ ë§í¬: ${shareUrl}`);
                displayMessage('System', `ê°•ì˜ ID (${roomId})ì™€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìƒë“¤ê³¼ ê³µìœ í•˜ì„¸ìš”.`, 'system');

            } catch (err) {
                // getLocalStreamì—ì„œ ì´ë¯¸ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë„ì›€
                errorElement.textContent = 'ê°•ì˜ ì‹œì‘ ì‹¤íŒ¨: ë¯¸ë””ì–´ ë˜ëŠ” PeerJS ì˜¤ë¥˜';
                errorElement.classList.remove('hidden');
                console.error("Teacher Session Start Failed:", err);
            }
        }

        /**
         * í•™ìƒ ì„¸ì…˜ ì°¸ì—¬ (Client)
         */
        async function joinStudentSession() {
            const roomId = document.getElementById('student-room-id').value.trim();
            const displayName = document.getElementById('student-display-name').value.trim();
            const errorElement = document.getElementById('student-error');

            if (!roomId || !displayName) {
                errorElement.textContent = 'Host IDì™€ ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.';
                errorElement.classList.remove('hidden');
                return;
            }
            errorElement.classList.add('hidden');

            try {
                // 1. ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° (ì¹´ë©”ë¼/ë§ˆì´í¬)
                await getLocalStream();

                // 2. PeerJS ì´ˆê¸°í™” (ID ì—†ì´ ëœë¤ ìƒì„±)
                await initPeer(); 
                
                // 3. UI ì „í™˜
                changeView('room');
                
                // 4. Host (êµì‚¬)ì—ê²Œ ì—°ê²° ì‹œë„
                connectToPeer(roomId);
                displayMessage('System', `${roomId} ê°•ì˜ì— ì—°ê²°ì„ ì‹œë„ ì¤‘ì…ë‹ˆë‹¤...`, 'system');

            } catch (err) {
                // getLocalStreamì—ì„œ ì´ë¯¸ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë„ì›€
                errorElement.textContent = 'ê°•ì˜ ì°¸ì—¬ ì‹¤íŒ¨: ë¯¸ë””ì–´ ë˜ëŠ” PeerJS ì˜¤ë¥˜';
                errorElement.classList.remove('hidden');
                console.error("Student Join Failed:", err);
            }
        }

        // =================================================================
        // Media Controls
        // =================================================================

        /**
         * ë¹„ë””ì˜¤/ì˜¤ë””ì˜¤ ì¼œê¸°/ë„ê¸°
         * @param {('video'|'audio')} type - ì œì–´í•  ë¯¸ë””ì–´ íƒ€ì…
         */
        function toggleMedia(type) {
            if (!myStream) return;

            if (type === 'video') {
                isVideoOn = !isVideoOn;
                myStream.getVideoTracks().forEach(track => track.enabled = isVideoOn);
                document.getElementById('video-icon').textContent = isVideoOn ? 'ğŸ“¹' : 'ğŸš«';
                displayMessage('System', `ë¹„ë””ì˜¤ê°€ ${isVideoOn ? 'ì¼œì¡ŒìŠµë‹ˆë‹¤' : 'êº¼ì¡ŒìŠµë‹ˆë‹¤'}.`, 'system');
            } else if (type === 'audio') {
                isAudioOn = !isAudioOn;
                myStream.getAudioTracks().forEach(track => track.enabled = isAudioOn);
                document.getElementById('audio-icon').textContent = isAudioOn ? 'ğŸ¤' : 'ğŸ”‡';
                displayMessage('System', `ì˜¤ë””ì˜¤ê°€ ${isAudioOn ? 'ì¼œì¡ŒìŠµë‹ˆë‹¤' : 'êº¼ì¡ŒìŠµë‹ˆë‹¤'}.`, 'system');
            }
        }

        /**
         * í™”ë©´ ê³µìœ  ì‹œì‘/ì¢…ë£Œ
         */
        async function startScreenShare() {
            if (!isScreenSharing) {
                try {
                    // í™”ë©´ ê³µìœ  ìŠ¤íŠ¸ë¦¼ ìš”ì²­ (Window or Screen)
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: true, 
                        audio: isAudioOn 
                    });
                    
                    // í™”ë©´ ê³µìœ  ì¢…ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                    screenStream.getVideoTracks()[0].onended = () => stopScreenShare();

                    // 1. ë¡œì»¬ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ í™”ë©´ ê³µìœ  ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ êµì²´
                    const myVideoEl = document.getElementById('video-my-video');
                    if (myVideoEl) myVideoEl.srcObject = screenStream;

                    // 2. ì—°ê²°ëœ ëª¨ë“  í”¼ì–´ì—ê²Œ ìŠ¤íŠ¸ë¦¼ êµì²´ ì•Œë¦¼ ë° ì ìš©
                    Object.values(connections).forEach(conn => {
                        if (conn.call && conn.call.peerConnection) {
                            const videoTrack = screenStream.getVideoTracks()[0];
                            const sender = conn.call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                            if (sender) {
                                sender.replaceTrack(videoTrack).catch(err => console.error("Replace track failed:", err));
                            }
                            
                            // ë°ì´í„° ì±„ë„ì„ í†µí•œ ì•Œë¦¼
                            if (conn.dataConnection && conn.dataConnection.open) {
                                conn.dataConnection.send({ type: 'stream_change', status: 'í™”ë©´ ê³µìœ ' });
                            }
                        }
                    });

                    isScreenSharing = true;
                    document.getElementById('screen-share-icon').textContent = 'âŒ';
                    displayMessage('System', 'í™”ë©´ ê³µìœ ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.', 'system');

                } catch (err) {
                    console.error("í™”ë©´ ê³µìœ  ì‹œì‘ ì‹¤íŒ¨:", err);
                    displayMessage('System', 'í™”ë©´ ê³µìœ ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.', 'system');
                }
            } else {
                stopScreenShare();
            }
        }
        
        /**
         * í™”ë©´ ê³µìœ  ì¢…ë£Œ
         */
        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            // 1. ë¡œì»¬ ë¹„ë””ì˜¤ë¥¼ ì›¹ìº  ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë³µêµ¬
            const myVideoEl = document.getElementById('video-my-video');
            if (myVideoEl) myVideoEl.srcObject = myStream;

            // 2. ì—°ê²°ëœ ëª¨ë“  í”¼ì–´ì—ê²Œ ìŠ¤íŠ¸ë¦¼ ë³µêµ¬
            Object.values(connections).forEach(conn => {
                if (conn.call && conn.call.peerConnection) {
                    const videoTrack = myStream.getVideoTracks()[0];
                    const sender = conn.call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if (sender) {
                        sender.replaceTrack(videoTrack).catch(err => console.error("Restore track failed:", err));
                    }
                    
                    if (conn.dataConnection && conn.dataConnection.open) {
                        conn.dataConnection.send({ type: 'stream_change', status: 'í™”ë©´ ê³µìœ  ì¤‘ì§€' });
                    }
                }
            });

            isScreenSharing = false;
            document.getElementById('screen-share-icon').textContent = 'ğŸ–¥ï¸';
            displayMessage('System', 'í™”ë©´ ê³µìœ ë¥¼ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.', 'system');
        }

        // =================================================================
        // UI Layout and Fullscreen
        // =================================================================

        /**
         * ë¹„ë””ì˜¤ ë ˆì´ì•„ì›ƒì„ ë°”ë‘‘íŒì‹ ë˜ëŠ” ì „ì²´í™”ë©´ ëª¨ë“œë¡œ ì—…ë°ì´íŠ¸
         */
        function updateVideoLayout() {
            const videoPanel = document.getElementById('video-panel');
            const videoGrid = document.getElementById('video-grid');
            const videos = videoGrid.querySelectorAll('.video-container');
            
            // ì „ì²´í™”ë©´ ëª¨ë“œê°€ ì•„ë‹ ë•Œ (ë°”ë‘‘íŒ)
            if (!isVideoFullscreen) {
                videoPanel.classList.remove('fullscreen-mode');
                videoGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
                videos.forEach(v => {
                    v.classList.remove('main-video');
                    v.style.width = '';
                    v.style.height = '';
                });
                // ì±„íŒ… íŒ¨ë„ì„ ë‹¤ì‹œ ë³´ì´ê²Œ í•©ë‹ˆë‹¤
                document.getElementById('chat-panel').classList.remove('hidden');
                document.getElementById('fullscreen-chat-btn').classList.add('hidden');
                document.getElementById('chat-close-btn').classList.add('hidden');
            } else {
                 // ì „ì²´í™”ë©´ ëª¨ë“œ
                videoPanel.classList.add('fullscreen-layout');
                document.getElementById('fullscreen-chat-btn').classList.remove('hidden');

                // ì²« ë²ˆì§¸ ë¹„ë””ì˜¤ë¥¼ ë©”ì¸ìœ¼ë¡œ ì„¤ì •
                if (videos.length > 0) {
                    videos[0].classList.add('main-video');
                }
            }
        }

        /**
         * ë¹„ë””ì˜¤ ì „ì²´í™”ë©´ ëª¨ë“œ í† ê¸€
         */
        function toggleVideoFullscreen() {
            isVideoFullscreen = !isVideoFullscreen;
            const roomView = document.getElementById('room-view');
            const chatPanel = document.getElementById('chat-panel');

            if (isVideoFullscreen) {
                roomView.classList.add('fullscreen-layout');
                chatPanel.classList.add('hidden');
                document.getElementById('fullscreen-icon').textContent = 'ğŸ“º'; // ì¶•ì†Œ ì•„ì´ì½˜
            } else {
                roomView.classList.remove('fullscreen-layout');
                chatPanel.classList.remove('hidden');
                document.getElementById('fullscreen-icon').textContent = 'ğŸ“º'; // ì „ì²´í™”ë©´ ì•„ì´ì½˜ (ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì „ì²´í™”ë©´)
            }
            updateVideoLayout();
        }

        /**
         * ì±„íŒ… íŒ¨ë„ í‘œì‹œ/ìˆ¨ê¸°ê¸° (ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œ ì‚¬ìš©)
         * @param {boolean} show - ì±„íŒ… íŒ¨ë„ì„ í‘œì‹œí• ì§€ ì—¬ë¶€
         */
        function toggleChatDisplay(show) {
            const chatPanel = document.getElementById('chat-panel');
            const videoPanel = document.getElementById('video-panel');
            const fullscreenChatBtn = document.getElementById('fullscreen-chat-btn');
            const chatCloseBtn = document.getElementById('chat-close-btn');

            if (show) {
                chatPanel.classList.remove('hidden');
                chatCloseBtn.classList.remove('hidden');
                fullscreenChatBtn.classList.add('hidden');
                // ë¹„ë””ì˜¤ íŒ¨ë„ í¬ê¸° ì¡°ì • (ë°ìŠ¤í¬í†±ì—ì„œ ì±„íŒ…ì°½ ì—´ë¦´ ë•Œ)
                if (window.innerWidth >= 768) {
                    videoPanel.style.width = 'calc(100% - 24rem)'; // 96px = 24rem
                }
            } else {
                chatPanel.classList.add('hidden');
                fullscreenChatBtn.classList.remove('hidden');
                // ë¹„ë””ì˜¤ íŒ¨ë„ í¬ê¸° ë³µì›
                videoPanel.style.width = '100%';
            }
        }
        
        // =================================================================
        // Chat and Data Features
        // =================================================================

        let chatHistory = [];

        /**
         * ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
         */
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            const senderName = document.getElementById('student-display-name').value || myPeerId || 'ë‚˜';

            if (!message) return;

            // ë¡œì»¬ì— í‘œì‹œ
            displayMessage(senderName, message, 'local');

            // ì—°ê²°ëœ ëª¨ë“  í”¼ì–´ì—ê²Œ ì „ì†¡
            Object.values(connections).forEach(conn => {
                if (conn.dataConnection && conn.dataConnection.open) {
                    conn.dataConnection.send({ 
                        type: 'chat', 
                        message: message 
                    });
                }
            });

            input.value = '';
        }

        /**
         * íŒŒì¼ ì „ì†¡ ì²˜ë¦¬
         */
        function sendFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            const senderName = document.getElementById('student-display-name').value || myPeerId || 'ë‚˜';

            if (!file) return;

            // íŒŒì¼ ì •ë³´ í‘œì‹œ (ë¡œì»¬)
            displayMessage(senderName, `íŒŒì¼ ì „ì†¡: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'file');

            // íŒŒì¼ì„ ArrayBufferë¡œ ì½ê¸°
            const reader = new FileReader();
            reader.onload = function(evt) {
                const arrayBuffer = evt.target.result;
                const fileData = {
                    type: 'file',
                    name: file.name,
                    size: file.size,
                    fileType: file.type,
                    data: arrayBuffer // PeerJSëŠ” DataChannelì„ í†µí•´ ArrayBufferë¥¼ ì²­í¬ë¡œ ë¶„í• í•˜ì—¬ ì „ì†¡í•©ë‹ˆë‹¤.
                };

                // ì—°ê²°ëœ ëª¨ë“  í”¼ì–´ì—ê²Œ ì „ì†¡
                Object.values(connections).forEach(conn => {
                    if (conn.dataConnection && conn.dataConnection.open) {
                        conn.dataConnection.send(fileData);
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }

        /**
         * íŒŒì¼ ìˆ˜ì‹  ì²˜ë¦¬ ë° ë‹¤ìš´ë¡œë“œ ë§í¬ ì œê³µ
         */
        function handleFileReceive(senderName, data) {
            if (data.type !== 'file' || !data.data) return;

            // Blob ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë§í¬
            const blob = new Blob([data.data], { type: data.fileType });
            const url = URL.createObjectURL(blob);
            
            const message = `íŒŒì¼ ìˆ˜ì‹ : ${data.name} (${(data.size / 1024).toFixed(2)} KB) <a href="${url}" download="${data.name}" class="text-blue-600 underline font-bold">ë‹¤ìš´ë¡œë“œ</a>`;
            displayMessage(senderName, message, 'file');
        }

        /**
         * ì±„íŒ… ê¸°ë¡ì„ CSV íŒŒì¼ë¡œ ì €ì¥
         */
        function saveChatToCSV() {
            if (chatHistory.length === 0) {
                displayMessage('System', 'ì €ì¥í•  ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.', 'system');
                return;
            }

            let csvContent = "Time,Sender,Message,Type\n";
            chatHistory.forEach(item => {
                // ë©”ì‹œì§€ ë‚´ìš©ì—ì„œ ì¤„ ë°”ê¿ˆ, ì‰¼í‘œ, ì´ì¤‘ ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                const message = `"${item.message.replace(/"/g, '""').replace(/\n/g, '\\n')}"`; 
                csvContent += `${item.time},${item.sender},${message},${item.type}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `ezlive_chat_${new Date().toISOString()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            displayMessage('System', 'ì±„íŒ… ê¸°ë¡ì„ CSV íŒŒì¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.', 'system');
        }
        
        // =================================================================
        // Whiteboard (Drawing Tool) Logic
        // =================================================================
        
        /**
         * íŒì„œ ë„êµ¬ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° í† ê¸€
         */
        function toggleWhiteboard() {
            if (whiteboardModal.open) {
                closeWhiteboard();
            } else {
                openWhiteboard();
            }
        }
        
        /**
         * íŒì„œ ë„êµ¬ ì—´ê¸°
         */
        function openWhiteboard() {
            whiteboardModal.showModal();
            initWhiteboardCanvas();
            document.getElementById('board-icon').textContent = 'ğŸ¨';
        }
        
        /**
         * íŒì„œ ë„êµ¬ ë‹«ê¸° (ì¢…ë£Œ ë²„íŠ¼)
         */
        function closeWhiteboard() {
            whiteboardModal.close();
            document.getElementById('board-icon').textContent = 'ğŸ–Œï¸';
            displayMessage('System', 'íŒì„œ ë„êµ¬ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.', 'system');
        }

        /**
         * ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
         */
        function initWhiteboardCanvas() {
            canvas = document.getElementById('whiteboard-canvas');
            ctx = canvas.getContext('2d');
            
            // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ í¬ê¸°ë¥¼ ë¶€ëª¨ ìš”ì†Œì— ë§ê²Œ ì¡°ì •
            function resizeCanvas() {
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
                if (whiteboardPages[currentPage]) {
                    const img = new Image();
                    img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); };
                    img.src = whiteboardPages[currentPage];
                }
            }
            
            // ì´ˆê¸° í¬ê¸° ì„¤ì • ë° ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            whiteboardModal.onclose = () => window.removeEventListener('resize', resizeCanvas);

            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e.touches[0]);
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e.touches[0]);
            });
            canvas.addEventListener('touchend', stopDrawing);
            
            // ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ ë˜ëŠ” ìƒì„±
            if (whiteboardPages.length === 0) {
                newWhiteboardPage(false); // ì´ˆê¸° í˜ì´ì§€ ìƒì„±
            } else {
                loadWhiteboardPage(currentPage);
            }
        }

        /**
         * ê·¸ë¦¬ê¸° ë„êµ¬ ì„¤ì •
         */
        function setTool(tool) {
            currentTool = tool;
            // UI ì—…ë°ì´íŠ¸
            ['pen', 'eraser', 'pointer'].forEach(t => {
                const btn = document.getElementById(`tool-${t}`);
                if (btn) {
                    btn.classList.toggle('bg-blue-500', t === tool);
                    btn.classList.toggle('bg-gray-300', t !== tool);
                    btn.classList.toggle('text-white', t === tool);
                    btn.classList.toggle('text-gray-800', t !== tool);
                }
            });
        }
        
        /**
         * ê·¸ë¦¬ê¸° ì‹œì‘
         */
        function startDrawing(e) {
            if (currentTool === 'pointer') return;
            isDrawing = true;
            [lastX, lastY] = getCanvasCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            
            // ì²« ì ì„ ê·¸ë¦¬ê¸° ìœ„í•´ draw í˜¸ì¶œ
            draw(e, true); 
        }

        /**
         * ê·¸ë¦¬ê¸° ì‹¤í–‰
         */
        function draw(e, isStart = false) {
            if (!isDrawing || currentTool === 'pointer') return;
            const [x, y] = getCanvasCoordinates(e);
            
            // í˜„ì¬ ì„¤ì • ì ìš©
            ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : document.getElementById('whiteboard-color').value;
            ctx.lineWidth = currentTool === 'eraser' ? document.getElementById('whiteboard-size').value * 2 : document.getElementById('whiteboard-size').value;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';

            if (isStart) {
                ctx.fillRect(x, y, 1, 1); // ì‹œì‘ì ì—ì„œ ì‘ì€ ì ì„ ê·¸ë ¤ì¤ë‹ˆë‹¤.
            } else {
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            // P2P ë™ê¸°í™”ë¥¼ ìœ„í•´ ê·¸ë¦¬ê¸° ëª…ë ¹ ì „ì†¡
            sendDrawingCommand({
                type: 'draw',
                tool: currentTool,
                color: ctx.strokeStyle,
                size: ctx.lineWidth,
                x1: lastX / canvas.width,
                y1: lastY / canvas.height,
                x2: x / canvas.width,
                y2: y / canvas.height,
                page: currentPage
            });

            [lastX, lastY] = [x, y];
        }

        /**
         * ê·¸ë¦¬ê¸° ì¢…ë£Œ
         */
        function stopDrawing() {
            isDrawing = false;
            // í˜„ì¬ í˜ì´ì§€ ìƒíƒœ ì €ì¥
            saveCurrentPageSnapshot();
        }

        /**
         * ë§ˆìš°ìŠ¤/í„°ì¹˜ ì¢Œí‘œë¥¼ ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜
         */
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            return [x, y];
        }
        
        /**
         * íŒì„œ ëª…ë ¹ì„ ëª¨ë“  í”¼ì–´ì—ê²Œ ì „ì†¡
         */
        function sendDrawingCommand(command) {
            Object.values(connections).forEach(conn => {
                if (conn.dataConnection && conn.dataConnection.open) {
                    conn.dataConnection.send({ type: 'drawing', ...command });
                }
            });
        }

        /**
         * ìˆ˜ì‹ ëœ íŒì„œ ëª…ë ¹ì„ ìº”ë²„ìŠ¤ì— ì‹¤í–‰
         */
        function executeDrawingCommand(data) {
            if (!whiteboardModal.open || data.page !== currentPage) return;
            
            // í¬ê¸° ë³´ì •ì„ ìœ„í•´ ìº”ë²„ìŠ¤ í¬ê¸° ì‚¬ìš©
            const x1 = data.x1 * canvas.width;
            const y1 = data.y1 * canvas.height;
            const x2 = data.x2 * canvas.width;
            const y2 = data.y2 * canvas.height;
            
            ctx.strokeStyle = data.tool === 'eraser' ? '#ffffff' : data.color;
            ctx.lineWidth = data.size;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = data.tool === 'eraser' ? 'destination-out' : 'source-over';

            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }

        // --- í˜ì´ì§€ ê´€ë¦¬ ë° ì €ì¥ ---

        /**
         * í˜„ì¬ í˜ì´ì§€ì˜ ìƒíƒœë¥¼ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì €ì¥
         */
        function saveCurrentPageSnapshot() {
            if (canvas && ctx) {
                whiteboardPages[currentPage] = canvas.toDataURL();
            }
            updatePageDisplay();
        }

        /**
         * íŠ¹ì • í˜ì´ì§€ì˜ ìƒíƒœë¥¼ ìº”ë²„ìŠ¤ì— ë¡œë“œ
         */
        function loadWhiteboardPage(index) {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            if (whiteboardPages[index]) {
                const img = new Image();
                img.onload = () => { 
                    // ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ê·¸ë¦¬ê¸°
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height); 
                };
                img.src = whiteboardPages[index];
            } else {
                // ìƒˆ í˜ì´ì§€ (ë¹ˆ í˜ì´ì§€)
                ctx.fillStyle = '#ffffff'; // ë°°ê²½ì„ í°ìƒ‰ìœ¼ë¡œ ì±„ìš°ê¸°
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // ë¹ˆ í˜ì´ì§€ ìƒíƒœ ì €ì¥ (í°ìƒ‰ ë°°ê²½)
                whiteboardPages[index] = canvas.toDataURL();
            }
            currentPage = index;
            updatePageDisplay();
        }

        /**
         * ìƒˆ í˜ì´ì§€ ìƒì„± (ê¸°ì¡´ í˜ì´ì§€ ì„ì‹œ ì €ì¥)
         */
        function newWhiteboardPage() {
            saveCurrentPageSnapshot(); // í˜„ì¬ í˜ì´ì§€ ì €ì¥
            currentPage++;
            // ìƒˆ í˜ì´ì§€ë¥¼ ë¹ˆ ìƒíƒœë¡œ ë°°ì—´ì— ì¶”ê°€ (ë°°ì—´ ê¸¸ì´ë¥¼ ëŠ˜ë¦¼)
            if (whiteboardPages.length < currentPage + 1) {
                whiteboardPages.push(null); 
            }
            loadWhiteboardPage(currentPage);
            displayMessage('System', `íŒì„œ ìƒˆ í˜ì´ì§€(${currentPage + 1})ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.`, 'system');
        }

        /**
         * í˜ì´ì§€ ë²ˆí˜¸ ë³€ê²½
         */
        function whiteboardPageChange(direction) {
            saveCurrentPageSnapshot(); // í˜„ì¬ í˜ì´ì§€ ì €ì¥
            let newPage = currentPage + direction;
            if (newPage >= 0 && newPage < whiteboardPages.length) {
                loadWhiteboardPage(newPage);
            }
        }
        
        /**
         * í˜„ì¬ ìº”ë²„ìŠ¤ ì „ì²´ ì§€ìš°ê¸°
         */
        function clearWhiteboardPage() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // í°ìƒ‰ ë°°ê²½ìœ¼ë¡œ ë‹¤ì‹œ ì±„ìš°ê¸°
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveCurrentPageSnapshot();
            sendDrawingCommand({ type: 'clear', page: currentPage });
        }

        /**
         * í˜ì´ì§€ ë²ˆí˜¸ UI ì—…ë°ì´íŠ¸
         */
        function updatePageDisplay() {
            document.getElementById('current-page-num').textContent = currentPage + 1;
            document.getElementById('total-pages-num').textContent = whiteboardPages.length;
        }

        /**
         * í˜„ì¬ í˜ì´ì§€ë¥¼ PNGë¡œ ì €ì¥
         */
        function saveCurrentPageAsPNG() {
            if (!canvas) return;
            const link = document.createElement('a');
            link.download = `ezlive_page_${currentPage + 1}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            displayMessage('System', `í˜ì´ì§€ ${currentPage + 1}ë¥¼ PNGë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`, 'system');
        }

        /**
         * ëª¨ë“  í˜ì´ì§€ë¥¼ PDFë¡œ ì €ì¥
         */
        function saveAllPagesAsPDF() {
            if (whiteboardPages.length === 0 || !window.jspdf) {
                displayMessage('System', 'ì €ì¥í•  í˜ì´ì§€ê°€ ì—†ê±°ë‚˜ PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'system');
                return;
            }

            // ë§ˆì§€ë§‰ í˜ì´ì§€ ìŠ¤ëƒ…ìƒ· ì €ì¥
            saveCurrentPageSnapshot();
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();

            whiteboardPages.forEach((dataUrl, index) => {
                if (index > 0) {
                    doc.addPage();
                }
                if (dataUrl) {
                    // PNG ë°ì´í„° URLì„ PDFì— ì¶”ê°€
                    doc.addImage(dataUrl, 'PNG', 0, 0, pdfWidth, pdfHeight, null, 'FAST');
                    doc.text(`Page ${index + 1}`, pdfWidth - 30, pdfHeight - 10);
                }
            });

            doc.save(`ezlive_whiteboard_all_${new Date().toISOString()}.pdf`);
            displayMessage('System', `ì´ ${whiteboardPages.length}ê°œ í˜ì´ì§€ë¥¼ PDFë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`, 'system');
        }
        
        // =================================================================
        // Initialization and Event Listeners
        // =================================================================

        /**
         * í´ë¦½ë³´ë“œì— ë³µì‚¬ (ë³´ì•ˆ ë¬¸ì œë¡œ ì¸í•´ document.execCommand ì‚¬ìš©)
         */
        async function copyToClipboard(text) {
            try {
                // navigator.clipboard.writeTextëŠ” IFrameì—ì„œ ì œí•œë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, execCommandë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; // í™”ë©´ ë°–ìœ¼ë¡œ ì´ë™
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                console.log('Copied to clipboard:', text);
                return true;
            } catch (err) {
                console.error('Failed to copy text:', err);
                return false;
            }
        }
        
        // Enter í‚¤ë¡œ ì±„íŒ… ì „ì†¡
        document.getElementById('chat-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // URLì—ì„œ room IDì™€ name íŒŒì‹± (ë§í¬ ê³µìœ  ê¸°ëŠ¥)
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            const name = urlParams.get('name');

            if (roomId) {
                // ë§í¬ë¥¼ í†µí•´ ì ‘ì†í•œ ê²½ìš°, í•™ìƒ ì°¸ì—¬ í™”ë©´ìœ¼ë¡œ ë°”ë¡œ ì´ë™
                document.getElementById('student-room-id').value = roomId;
                if (name) document.getElementById('student-display-name').value = name;
                changeView('student_join');
            } else {
                changeView('home');
            }
        };

    </script>
</body>
</html>